<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>HAND Control Center</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <main class="container py-4">
    <header class="mb-4 hero p-4 rounded-4">
      <h1 class="h3 mb-1"><i class="bi bi-grid-1x2-fill me-2"></i>HAND Control Center</h1>
      <p class="text-secondary mb-0">Gesti√≥n unificada de proyectos en SALIDA, compilaci√≥n HAND y traducci√≥n de archivos.</p>
    </header>

    <section class="card shadow-sm mb-4 border-warning-subtle">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h5 mb-0"><i class="bi bi-lightning-charge-fill me-2"></i>Inicio r√°pido: comandos, emojis y tips</h2>
          <button type="button" class="btn btn-outline-secondary btn-sm js-show-help"
            data-title="Tips para empezar"
            data-help="1) Empieza en 'Compilar HAND r√°pido'. 2) Usa 'Workspace HAND' para crear archivos y convertir documentos. 3) Ejecuta 'Integrar proyecto' al final para unir el flujo. 4) Usa los botones con ayuda para ver qu√© hace cada acci√≥n antes de correrla."
            data-command="Tips interactivos para uso inicial.">
            <i class="bi bi-stars me-1"></i>Tips
          </button>
        </div>

        <div class="row g-3">
          <div class="col-12 col-xl-6">
            <div class="card h-100 quick-card">
              <div class="card-body">
                <h3 class="h6 mb-2">Men√∫ de comandos comunes</h3>
                <p class="small text-secondary mb-2">Ejecuta tareas frecuentes con confirmaci√≥n y ayuda emergente.</p>
                <form method="post" action="/run-common-command" id="common-command-form" class="row g-2">
                  <div class="col-12">
                    <select name="common_action_key" id="common_action_key" class="form-select">
                      {% for action in common_commands %}
                        <option
                          value="{{ action.key }}"
                          data-label="{{ action.label }}"
                          data-help="{{ action.description }}"
                          data-command="{{ action.command | join(' ') }}"
                        >{{ action.label }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-12 d-flex gap-2">
                    <button type="button" class="btn btn-warning btn-sm" id="run-common-command-btn">
                      <i class="bi bi-terminal me-1"></i>Ejecutar comando
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm js-show-help"
                      data-title="C√≥mo usar comandos comunes"
                      data-help="Selecciona una tarea del men√∫ y pulsa ejecutar. Antes de correr, ver√°s un emergente con tips y comando exacto."
                      data-command="Seleccionar ‚Üí revisar tips ‚Üí ejecutar.">
                      <i class="bi bi-question-circle me-1"></i>Ayuda
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div class="col-12 col-xl-6">
            <div class="card h-100 quick-card">
              <div class="card-body">
                <h3 class="h6 mb-2">Men√∫s para introducir comandos y emojis</h3>
                <p class="small text-secondary mb-2">Inserta snippets de comandos y emojis directamente en el editor activo.</p>

                <div class="row g-2 mb-2">
                  <div class="col-md-8">
                    <select id="snippet_select" class="form-select form-select-sm">
                      <option value="show &quot;Hola HAND&quot;">show &quot;Hola HAND&quot;</option>
                      <option value="ask nombre\nshow &quot;Hola &quot; + nombre">ask nombre + saludo</option>
                      <option value="if true:\n    show &quot;ok&quot;">if b√°sico</option>
                      <option value="while contador &lt; 3:\n    show contador">while b√°sico</option>
                      <option value="fn sumar(a:int, b:int) -&gt; int:\n    return a + b">funci√≥n con retorno</option>
                    </select>
                  </div>
                  <div class="col-md-4 d-grid">
                    <button type="button" class="btn btn-outline-primary btn-sm" id="insert-snippet-btn">
                      <i class="bi bi-braces me-1"></i>Insertar snippet
                    </button>
                  </div>
                </div>

                <div class="row g-2 mb-2">
                  <div class="col-md-7">
                    <input type="text" class="form-control form-control-sm" id="emoji-search" placeholder="Buscar emoji, descripci√≥n o tipo de funci√≥n">
                  </div>
                  <div class="col-md-5">
                    <select id="emoji-category" class="form-select form-select-sm">
                      <option value="">Todas las categor√≠as</option>
                    </select>
                  </div>
                </div>
                <div class="small text-secondary mb-2" id="emoji-count"></div>
                <div class="small text-secondary mb-2">La b√∫squeda incluye: tipo de funci√≥n HAND, descripci√≥n del emoji y capa activa.</div>
                <div id="emoji-palette" class="emoji-palette">
                </div>
                <div class="d-flex align-items-center justify-content-between mt-2 gap-2">
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="emoji-prev-page">
                    <i class="bi bi-chevron-left"></i>Anterior
                  </button>
                  <div class="small text-secondary text-center" id="emoji-page-info">P√°gina 1 de 1</div>
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="emoji-next-page">
                    Siguiente<i class="bi bi-chevron-right"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h5 mb-0"><i class="bi bi-gear-wide-connected me-2"></i>Compilar HAND r√°pido</h2>
          <span class="badge text-bg-primary">Compilaci√≥n</span>
        </div>
        <p class="small text-secondary">Compila un snippet HAND en el target elegido y opcionalmente ejecuta la salida Python.</p>
        <form method="post" action="/compile-hand" class="row g-3" id="compile-form">
          <div class="col-12">
            <label class="form-label">C√≥digo HAND</label>
            <textarea name="hand_source" class="form-control editor" rows="8" placeholder="show &quot;hola&quot;"></textarea>
          </div>
          <div class="col-md-4">
            <label class="form-label">Target</label>
            <select name="target" class="form-select" id="compile-target">
              <option value="python">python</option>
              <option value="html">html</option>
              <option value="sql">sql</option>
              <option value="rust">rust</option>
              <option value="wasm">wasm</option>
            </select>
          </div>
          <div class="col-md-8">
            <label class="form-label">Carpeta de salida</label>
            <input type="text" name="out_dir" class="form-control" value="{{ default_out }}">
          </div>
          <div class="col-12 form-check ms-1">
            <input class="form-check-input" type="checkbox" id="run_python" name="run_python">
            <label class="form-check-label" for="run_python">Si target=python, ejecutar tambi√©n program.py</label>
          </div>
          <div class="col-12 d-flex gap-2">
            <button
              type="button"
              class="btn btn-primary js-help-submit"
              data-title="Compilar HAND"
              data-help="Compila el c√≥digo HAND con handc.py (MVP). Opciones: target (python/html/sql/rust/wasm), carpeta de salida y ejecuci√≥n posterior de program.py para target python."
              data-command="python handc.py <input.hand> --target <target> --out <out_dir> --emit-ir <out_dir>/program.ir.json"
              data-form-id="compile-form"
            >
              <i class="bi bi-play-circle me-1"></i>Compilar
            </button>
            <button type="button" class="btn btn-outline-secondary js-show-help"
              data-title="Opciones de compilaci√≥n"
              data-help="C√≥digo HAND: texto fuente a compilar. Target: formato de salida. Carpeta de salida: ruta donde se generan artefactos. Ejecutar program.py: solo aplica a target python."
              data-command="No ejecuta; solo muestra ayuda de opciones.">
              <i class="bi bi-question-circle me-1"></i>Ayuda
            </button>
          </div>
          <input type="hidden" name="default_translate_in" value="{{ default_translate_in }}">
          <input type="hidden" name="default_translate_out" value="{{ default_translate_out }}">
        </form>

        <div class="emoji-program-guide mt-3" id="emoji-program-guide">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
            <h3 class="h6 mb-0"><i class="bi bi-info-circle-fill me-1"></i>Gu√≠a de emojis para el programa</h3>
            <span class="badge text-bg-primary" id="emoji-guide-layer">Capa activa: python</span>
          </div>
          <div class="small mb-2" id="emoji-guide-main">Selecciona un emoji para ver su funci√≥n en HAND y un ejemplo inmediato para la capa activa.</div>
          <div class="small mb-2" id="emoji-guide-selected">Emoji seleccionado: ninguno.</div>
          <div class="small mb-2" id="emoji-guide-related">Sugerencias: sin selecci√≥n todav√≠a.</div>
          <div class="small" id="emoji-guide-map">Funciones disponibles: validaci√≥n, flujo, salida UI, datos/c√°lculo, archivos, configuraci√≥n/build, seguridad y comunicaci√≥n.</div>
        </div>
      </div>
    </section>

    <section class="card shadow-sm mb-4 border-primary-subtle">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h5 mb-0"><i class="bi bi-hdd-stack-fill me-2"></i>Workspace HAND (carpetas y archivos)</h2>
          <span class="badge text-bg-info">Gesti√≥n</span>
        </div>
        <p class="small text-secondary">Zona para mantener archivos, subir documentos, convertirlos a HAND y ejecutar programas HAND.</p>

        <div class="row g-3 mb-3">
          <div class="col-12 col-xl-6">
            <div class="card h-100">
              <div class="card-body">
                <h3 class="h6">Crear carpeta</h3>
                <form method="post" action="/workspace/create-folder" id="workspace-create-folder-form" class="row g-2">
                  <div class="col-12">
                    <input name="folder_rel" class="form-control" placeholder="ejemplo: hand_zone/proyecto_a">
                  </div>
                  <div class="col-12">
                    <button
                      type="button"
                      class="btn btn-outline-primary btn-sm js-help-submit"
                      data-title="Crear carpeta"
                      data-help="Crea una carpeta dentro del workspace gestionado."
                      data-command="mkdir -p <ruta_relativa_workspace>"
                      data-form-id="workspace-create-folder-form"
                    >
                      <i class="bi bi-folder-plus me-1"></i>Crear carpeta
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div class="col-12 col-xl-6">
            <div class="card h-100">
              <div class="card-body">
                <h3 class="h6">Crear archivo</h3>
                <form method="post" action="/workspace/create-file" id="workspace-create-file-form" class="row g-2">
                  <div class="col-12">
                    <input name="file_rel" class="form-control" placeholder="ejemplo: hand_zone/demo.hand">
                  </div>
                  <div class="col-12">
                    <textarea name="file_content" class="form-control editor" rows="4" placeholder="show &quot;hola desde HAND&quot;"></textarea>
                  </div>
                  <div class="col-12">
                    <button
                      type="button"
                      class="btn btn-outline-primary btn-sm js-help-submit"
                      data-title="Crear archivo"
                      data-help="Crea un archivo en la ruta indicada y guarda el contenido inicial."
                      data-command="write <ruta_relativa_workspace>"
                      data-form-id="workspace-create-file-form"
                    >
                      <i class="bi bi-file-earmark-plus me-1"></i>Crear archivo
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-12 col-xl-6">
            <div class="card h-100">
              <div class="card-body">
                <h3 class="h6">Subir documentos para integrar</h3>
                <form method="post" action="/workspace/upload" enctype="multipart/form-data" id="workspace-upload-form" class="row g-2">
                  <div class="col-12">
                    <input type="file" name="documents" id="upload-documents-input" class="form-control" multiple>
                  </div>
                  <div class="col-12">
                    <div id="upload-dropzone" class="dropzone-upload" role="button" tabindex="0" aria-label="Zona para arrastrar y soltar archivos">
                      <i class="bi bi-cloud-arrow-up me-1"></i>
                      Arrastra y suelta archivos aqu√≠, o haz clic para seleccionarlos
                    </div>
                    <div class="small text-secondary mt-1" id="upload-dropzone-status">Sin archivos seleccionados.</div>
                  </div>
                  <div class="col-12 d-flex gap-2">
                    <button
                      type="button"
                      class="btn btn-outline-success btn-sm js-help-submit"
                      data-title="Subir documentos"
                      data-help="Sube uno o varios documentos al workspace (carpeta uploads) para integrarlos en el flujo HAND."
                      data-command="upload files -> workspace/uploads"
                      data-form-id="workspace-upload-form"
                    >
                      <i class="bi bi-upload me-1"></i>Subir documentos
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div class="col-12 col-xl-6">
            <div class="card h-100">
              <div class="card-body">
                <h3 class="h6">Traducir documentos subidos a HAND</h3>
                <form method="post" action="/workspace/translate-uploaded" id="workspace-translate-uploaded-form" class="row g-2">
                  <div class="col-md-6">
                    <select name="mode" class="form-select">
                      <option value="raw">raw (recomendado para docs)</option>
                      <option value="safe">safe</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <button
                      type="button"
                      class="btn btn-outline-success btn-sm w-100 js-help-submit"
                      data-title="Traducir documentos subidos"
                      data-help="Procesa la carpeta uploads y genera salida traducida en SALIDA/.web_manager/translated."
                      data-command="python -m hand_tree_translator.cli --in uploads --out translated --mode raw|safe --force"
                      data-form-id="workspace-translate-uploaded-form"
                    >
                      <i class="bi bi-arrow-repeat me-1"></i>Traducir subidos
                    </button>
                  </div>
                </form>

                <form method="post" action="/workspace/convert-to-hand" id="workspace-convert-hand-form" class="row g-2 mt-2">
                  <div class="col-12">
                    <input name="source_rel" class="form-control" placeholder="origen en workspace, ej: uploads/mi_doc.txt">
                  </div>
                  <div class="col-12">
                    <input name="output_rel" class="form-control" value="hand_zone/imported.hand" placeholder="destino .hand en workspace">
                  </div>
                  <div class="col-12">
                    <button
                      type="button"
                      class="btn btn-outline-primary btn-sm js-help-submit"
                      data-title="Convertir documento a HAND"
                      data-help="Convierte un documento textual del workspace a una versi√≥n HAND ejecutable en hand_zone."
                      data-command="convert <source> -> <output>.hand"
                      data-form-id="workspace-convert-hand-form"
                    >
                      <i class="bi bi-filetype-htm me-1"></i>Convertir a HAND
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <h3 class="h6">Explorador de workspace</h3>
                <div class="table-responsive workspace-table-wrap">
                  <table class="table table-sm align-middle">
                    <thead>
                      <tr>
                        <th>Tipo</th>
                        <th>Ruta</th>
                        <th>Tama√±o</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for entry in workspace_entries %}
                        <tr>
                          <td>
                            {% if entry.type == 'dir' %}
                              <span class="badge text-bg-light border"><i class="bi bi-folder-fill me-1"></i>Dir</span>
                            {% else %}
                              <span class="badge text-bg-light border"><i class="bi bi-file-earmark me-1"></i>File</span>
                            {% endif %}
                          </td>
                          <td class="small">{{ entry.rel }}</td>
                          <td class="small">{{ entry.size }}</td>
                          <td>
                            <div class="d-flex gap-1 flex-wrap">
                              {% if entry.type == 'file' %}
                                <form method="post" action="/workspace/open-file" class="d-inline" id="open-{{ loop.index }}">
                                  <input type="hidden" name="selected_file_rel" value="{{ entry.rel }}">
                                  <button type="button" class="btn btn-outline-primary btn-sm js-help-submit"
                                    data-title="Abrir archivo"
                                    data-help="Carga este archivo en el editor de la zona HAND."
                                    data-command="open {{ entry.rel }}"
                                    data-form-id="open-{{ loop.index }}">Abrir</button>
                                </form>
                              {% endif %}
                              <form method="post" action="/workspace/delete" class="d-inline" id="del-{{ loop.index }}">
                                <input type="hidden" name="path_rel" value="{{ entry.rel }}">
                                <button type="button" class="btn btn-outline-danger btn-sm js-help-submit"
                                  data-title="Eliminar"
                                  data-help="Elimina esta ruta del workspace (archivo o carpeta)."
                                  data-command="delete {{ entry.rel }}"
                                  data-form-id="del-{{ loop.index }}">Eliminar</button>
                              </form>
                            </div>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <h3 class="h6">Editor de archivo (zona HAND)</h3>
                <form method="post" action="/workspace/save-file" id="workspace-save-file-form" class="row g-2">
                  <div class="col-md-8">
                    <input name="selected_file_rel" class="form-control" value="{{ selected_file_rel }}" placeholder="ruta del archivo en workspace">
                  </div>
                  <div class="col-md-4 d-grid">
                    <button
                      type="button"
                      class="btn btn-primary btn-sm js-help-submit"
                      data-title="Guardar archivo"
                      data-help="Guarda el contenido actual del editor sobre el archivo seleccionado en workspace."
                      data-command="save <selected_file_rel>"
                      data-form-id="workspace-save-file-form"
                    >
                      <i class="bi bi-floppy me-1"></i>Guardar archivo
                    </button>
                  </div>
                  <div class="col-12">
                    <textarea name="selected_file_content" class="form-control editor" rows="10" placeholder="Contenido del archivo...">{{ selected_file_content }}</textarea>
                  </div>
                </form>

                <form method="post" action="/workspace/run-hand" id="workspace-run-hand-form" class="row g-2 mt-2">
                  <div class="col-md-6">
                    <input name="hand_rel" class="form-control" value="{{ selected_file_rel }}" placeholder="archivo .hand en workspace">
                  </div>
                  <div class="col-md-3">
                    <select name="target" class="form-select" id="workspace-target">
                      <option value="python">python</option>
                      <option value="html">html</option>
                      <option value="sql">sql</option>
                      <option value="rust">rust</option>
                      <option value="wasm">wasm</option>
                    </select>
                  </div>
                  <div class="col-md-3 d-flex align-items-center">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="run_python_workspace" name="run_python" checked>
                      <label class="form-check-label" for="run_python_workspace">Ejecutar Python</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <button
                      type="button"
                      class="btn btn-success btn-sm js-help-submit"
                      data-title="Compilar y ejecutar HAND"
                      data-help="Compila el archivo .hand seleccionado con handc.py y, si target=python, ejecuta tambi√©n el programa resultante."
                      data-command="python handc.py <archivo.hand> --target <target> --out SALIDA/.web_manager/runs/... --emit-ir ..."
                      data-form-id="workspace-run-hand-form"
                    >
                      <i class="bi bi-cpu me-1"></i>Compilar/Ejecutar HAND
                    </button>
                  </div>
                </form>

                <form method="post" action="/workspace/integrate-project" id="workspace-integrate-form" class="row g-2 mt-2">
                  <div class="col-12">
                    <button
                      type="button"
                      class="btn btn-warning btn-sm js-help-submit"
                      data-title="Integraci√≥n final del proyecto"
                      data-help="Genera un archivo HAND integrado con lo que tengas en workspace (hand_zone y uploads), luego compila y ejecuta en python para validar el flujo completo."
                      data-command="integrar -> compilar python -> ejecutar"
                      data-form-id="workspace-integrate-form"
                    >
                      <i class="bi bi-diagram-2-fill me-1"></i>Integrar proyecto (final)
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h5 mb-0"><i class="bi bi-diagram-3-fill me-2"></i>Traducir √°rbol de archivos</h2>
          <span class="badge text-bg-success">Traducci√≥n</span>
        </div>
        <p class="small text-secondary">Convierte una carpeta de c√≥digo a representaci√≥n HAND y separa no traducibles.</p>
        <form method="post" action="/translate-tree" class="row g-3" id="translate-form">
          <div class="col-md-6">
            <label class="form-label">Carpeta de entrada</label>
            <input type="text" name="in_root" class="form-control" value="{{ default_translate_in }}">
          </div>
          <div class="col-md-6">
            <label class="form-label">Carpeta de salida</label>
            <input type="text" name="translate_out" class="form-control" value="{{ default_translate_out }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">Modo</label>
            <select name="mode" class="form-select">
              <option value="safe">safe</option>
              <option value="raw">raw</option>
            </select>
          </div>
          <div class="col-md-8 d-flex align-items-end">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="force" name="force">
              <label class="form-check-label" for="force">Sobrescribir salida si existe</label>
            </div>
          </div>
          <div class="col-12 d-flex gap-2">
            <button
              type="button"
              class="btn btn-success js-help-submit"
              data-title="Traducir √°rbol"
              data-help="Ejecuta el traductor hand_tree_translator. Opciones: carpeta de entrada, carpeta de salida, modo safe/raw y force para sobrescribir salida existente."
              data-command="python -m hand_tree_translator.cli --in <carpeta> --out <carpeta> --mode safe|raw [--force]"
              data-form-id="translate-form"
            >
              <i class="bi bi-arrow-repeat me-1"></i>Traducir
            </button>
            <button type="button" class="btn btn-outline-secondary js-show-help"
              data-title="Opciones de traducci√≥n"
              data-help="Modo safe traduce solo construcciones seguras soportadas; modo raw envuelve m√°s contenido sin transformar sem√°ntica completa. Force permite sobrescritura de la salida."
              data-command="No ejecuta; solo muestra ayuda de opciones.">
              <i class="bi bi-question-circle me-1"></i>Ayuda
            </button>
          </div>
          <input type="hidden" name="default_input" value="{{ default_input }}">
          <input type="hidden" name="default_out" value="{{ default_out }}">
        </form>
      </div>
    </section>

    <section class="mb-4">
      <h2 class="h5 mb-3"><i class="bi bi-folder2-open me-2"></i>Proyectos detectados en SALIDA</h2>
      <div class="row g-3">
        {% for project in projects %}
          <div class="col-12 col-lg-6">
            <div class="card h-100 shadow-sm project-card">
              <div class="card-body">
                <h3 class="h6 mb-1 d-flex align-items-center gap-2">
                  <i class="bi bi-box-seam"></i>{{ project.name }}
                  <span class="badge text-bg-light border">{{ project.actions|length }} acciones</span>
                </h3>
                <p class="small text-secondary mb-3">{{ project.rel_path }}</p>

                {% if project.actions %}
                  <div class="d-grid gap-2">
                    {% for action in project.actions %}
                      <form method="post" action="/run-action" id="form-{{ project.name|replace('.', '-')|replace('_', '-')|replace('/', '-') }}-{{ action.key }}">
                        <input type="hidden" name="project_path" value="{{ project.rel_path }}">
                        <input type="hidden" name="action_key" value="{{ action.key }}">
                        <input type="hidden" name="default_input" value="{{ default_input }}">
                        <input type="hidden" name="default_out" value="{{ default_out }}">
                        <input type="hidden" name="default_translate_in" value="{{ default_translate_in }}">
                        <input type="hidden" name="default_translate_out" value="{{ default_translate_out }}">
                        <button
                          type="button"
                          class="btn btn-outline-primary btn-sm w-100 text-start js-help-submit"
                          data-title="{{ project.name }} ¬∑ {{ action.label }}"
                          data-help="{{ action.description }}"
                          data-command="{{ action.command | join(' ') }}"
                          data-form-id="form-{{ project.name|replace('.', '-')|replace('_', '-')|replace('/', '-') }}-{{ action.key }}"
                        >
                          <i class="bi bi-play-btn me-1"></i>{{ action.label }}
                        </button>
                        <div class="small text-secondary mt-1 d-flex align-items-center gap-2">
                          <i class="bi bi-info-circle"></i>{{ action.description }}
                        </div>
                      </form>
                    {% endfor %}
                  </div>
                {% else %}
                  <p class="small text-secondary mb-0">Sin acciones autom√°ticas detectadas.</p>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </section>

    {% if last_result %}
      <section class="card shadow-sm mb-4">
        <div class="card-body">
          <h2 class="h5">Resultado: {{ last_result.title }}</h2>
          <p class="small text-secondary mb-2">{{ last_result.command }}<br>{{ last_result.cwd }} ¬∑ {{ last_result.duration }}s ¬∑ rc={{ last_result.returncode }}</p>
          <div class="row g-3">
            <div class="col-12 col-lg-6">
              <h3 class="h6">stdout</h3>
              <pre>{{ last_result.stdout }}</pre>
            </div>
            <div class="col-12 col-lg-6">
              <h3 class="h6">stderr</h3>
              <pre>{{ last_result.stderr }}</pre>
            </div>
          </div>
        </div>
      </section>
    {% endif %}

    {% if compile_result %}
      <section class="card shadow-sm mb-4">
        <div class="card-body">
          <h2 class="h5">Resultado: {{ compile_result.title }}</h2>
          <p class="small text-secondary mb-2">{{ compile_result.command }}<br>{{ compile_result.cwd }} ¬∑ {{ compile_result.duration }}s ¬∑ rc={{ compile_result.returncode }}</p>
          <div class="row g-3">
            <div class="col-12 col-lg-6">
              <h3 class="h6">stdout</h3>
              <pre>{{ compile_result.stdout }}</pre>
            </div>
            <div class="col-12 col-lg-6">
              <h3 class="h6">stderr</h3>
              <pre>{{ compile_result.stderr }}</pre>
            </div>
          </div>
        </div>
      </section>
    {% endif %}

    {% if translate_result %}
      <section class="card shadow-sm mb-4">
        <div class="card-body">
          <h2 class="h5">Resultado: {{ translate_result.title }}</h2>
          <p class="small text-secondary mb-2">{{ translate_result.command }}<br>{{ translate_result.cwd }} ¬∑ {{ translate_result.duration }}s ¬∑ rc={{ translate_result.returncode }}</p>
          <div class="row g-3">
            <div class="col-12 col-lg-6">
              <h3 class="h6">stdout</h3>
              <pre>{{ translate_result.stdout }}</pre>
            </div>
            <div class="col-12 col-lg-6">
              <h3 class="h6">stderr</h3>
              <pre>{{ translate_result.stderr }}</pre>
            </div>
          </div>
        </div>
      </section>
    {% endif %}

    {% if workspace_result %}
      <section class="card shadow-sm mb-4">
        <div class="card-body">
          <h2 class="h5">Resultado Workspace: {{ workspace_result.title }}</h2>
          <p class="small text-secondary mb-2">{{ workspace_result.command }}<br>{{ workspace_result.cwd }} ¬∑ {{ workspace_result.duration }}s ¬∑ rc={{ workspace_result.returncode }}</p>
          <div class="row g-3">
            <div class="col-12 col-lg-6">
              <h3 class="h6">stdout</h3>
              <pre>{{ workspace_result.stdout }}</pre>
            </div>
            <div class="col-12 col-lg-6">
              <h3 class="h6">stderr</h3>
              <pre>{{ workspace_result.stderr }}</pre>
            </div>
          </div>
        </div>
      </section>
    {% endif %}

    {% if hand_exec_result %}
      <section class="card shadow-sm mb-4">
        <div class="card-body">
          <h2 class="h5">Resultado HAND: {{ hand_exec_result.title }}</h2>
          <p class="small text-secondary mb-2">{{ hand_exec_result.command }}<br>{{ hand_exec_result.cwd }} ¬∑ {{ hand_exec_result.duration }}s ¬∑ rc={{ hand_exec_result.returncode }}</p>
          <div class="row g-3">
            <div class="col-12 col-lg-6">
              <h3 class="h6">stdout</h3>
              <pre>{{ hand_exec_result.stdout }}</pre>
            </div>
            <div class="col-12 col-lg-6">
              <h3 class="h6">stderr</h3>
              <pre>{{ hand_exec_result.stderr }}</pre>
            </div>
          </div>
        </div>
      </section>
    {% endif %}
  </main>

  <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title fs-5" id="helpModalLabel">Ayuda</h3>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p id="helpModalText" class="mb-2"></p>
          <label class="form-label small text-secondary mb-1">Comando/acci√≥n</label>
          <pre id="helpModalCommand" class="mb-0"></pre>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-primary d-none" id="helpModalExecute">
            <i class="bi bi-play-circle me-1"></i>Ejecutar ahora
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="onboardingModal" tabindex="-1" aria-labelledby="onboardingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title fs-5" id="onboardingModalLabel">Gu√≠a r√°pida para empezar</h3>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <ul class="mb-0">
            <li>Usa <strong>Inicio r√°pido</strong> para lanzar comandos comunes y aprender opciones.</li>
            <li>En <strong>Compilar HAND r√°pido</strong>, prueba snippets y cambia target (python/html/sql/rust/wasm).</li>
            <li>En <strong>Workspace HAND</strong>, crea archivos, sube documentos y convi√©rtelos a formato HAND.</li>
            <li>Pulsa <strong>Integrar proyecto (final)</strong> cuando quieras validar todo el flujo en una sola acci√≥n.</li>
            <li>Cada bot√≥n principal abre un emergente con tips antes de ejecutar.</li>
          </ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-primary" id="onboardingUnderstood">Entendido</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function () {
      const modalEl = document.getElementById('helpModal');
      const titleEl = document.getElementById('helpModalLabel');
      const textEl = document.getElementById('helpModalText');
      const cmdEl = document.getElementById('helpModalCommand');
      const execBtn = document.getElementById('helpModalExecute');
      const modal = new bootstrap.Modal(modalEl);
      const onboardingEl = document.getElementById('onboardingModal');
      const onboardingModal = new bootstrap.Modal(onboardingEl);
      const onboardingBtn = document.getElementById('onboardingUnderstood');

      let activeEditor = null;

      function openHelp(title, help, command, formId) {
        titleEl.textContent = title || 'Ayuda';
        textEl.textContent = help || 'Sin detalles disponibles.';
        cmdEl.textContent = command || 'Sin comando asociado.';

        if (formId) {
          execBtn.classList.remove('d-none');
          execBtn.onclick = function () {
            const form = document.getElementById(formId);
            if (form) {
              form.submit();
            }
          };
        } else {
          execBtn.classList.add('d-none');
          execBtn.onclick = null;
        }

        modal.show();
      }

      document.querySelectorAll('.js-help-submit').forEach((btn) => {
        btn.addEventListener('click', function () {
          openHelp(
            this.dataset.title,
            this.dataset.help,
            this.dataset.command,
            this.dataset.formId
          );
        });
      });

      document.querySelectorAll('.js-show-help').forEach((btn) => {
        btn.addEventListener('click', function () {
          openHelp(
            this.dataset.title,
            this.dataset.help,
            this.dataset.command,
            null
          );
        });
      });

      document.querySelectorAll('textarea.editor').forEach((area) => {
        area.addEventListener('focus', function () {
          activeEditor = this;
        });
      });

      function insertAtCursor(textarea, text) {
        if (!textarea) {
          return;
        }
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const value = textarea.value;
        textarea.value = value.substring(0, start) + text + value.substring(end);
        const pos = start + text.length;
        textarea.selectionStart = pos;
        textarea.selectionEnd = pos;
        textarea.focus();
      }

      const snippetSelect = document.getElementById('snippet_select');
      const snippetBtn = document.getElementById('insert-snippet-btn');
      if (snippetBtn && snippetSelect) {
        snippetBtn.addEventListener('click', function () {
          const text = snippetSelect.value || '';
          const editor = activeEditor || document.querySelector('textarea.editor');
          insertAtCursor(editor, text);
        });
      }

      let emojiCatalog = [];
      let emojiGroups = [];
      let activeLayer = 'python';
      let selectedEmoji = null;
      const emojiState = {
        query: '',
        category: '',
        page: 1,
        pageSize: 120,
      };

      function inferEmojiFunction(item) {
        const text = `${item.name || ''} ${item.subgroup || ''} ${item.group || ''}`.toLowerCase();
        const has = (pattern) => pattern.test(text);

        if (has(/check|cross|warning|prohibited|stop|mark|error|no entry/)) {
          return {
            type: 'Validaci√≥n y estado',
            brief: 'Marca si algo est√° correcto, fall√≥ o necesita atenci√≥n.',
            examples: {
              python: 'verify total >= 0\nshow "‚úÖ validado"',
              html: 'show "‚úÖ bloque listo para HTML"',
              sql: 'verify id != null\nshow "‚ö†Ô∏è revisar filas nulas"',
              rust: 'verify ok\nshow "üõë revisar rama cr√≠tica"',
              wasm: 'show "‚úÖ listo para exportar wasm"',
            },
          };
        }

        if (has(/arrow|repeat|clockwise|left-right|up-down|fast-forward|rewind/)) {
          return {
            type: 'Control de flujo',
            brief: 'Representa iteraciones, ramificaciones o avance del flujo.',
            examples: {
              python: 'while pasos < 3:\n    show "üîÅ paso"',
              html: 'if mostrar:\n    show "‚û°Ô∏è secci√≥n activa"',
              sql: 'if filtro_ok:\n    show "‚ÜîÔ∏è join habilitado"',
              rust: 'while flag:\n    show "‚¨ÜÔ∏è iteraci√≥n"',
              wasm: 'if cargar:\n    show "‚è≥ inicializando"',
            },
          };
        }

        if (has(/folder|file|package|document|paper|card index|archive|inbox|outbox/)) {
          return {
            type: 'Gesti√≥n de archivos',
            brief: 'Indica lectura, escritura, paquetes o movimiento de documentos.',
            examples: {
              python: 'show "üìÅ carpeta de salida preparada"',
              html: 'show "üìÑ plantilla lista"',
              sql: 'show "üì¶ lote SQL generado"',
              rust: 'show "üóÇÔ∏è m√≥dulos compilados"',
              wasm: 'show "üì§ artefacto wasm exportado"',
            },
          };
        }

        if (has(/gear|wrench|hammer|toolbox|pick|nut and bolt|bricks?/)) {
          return {
            type: 'Configuraci√≥n y build',
            brief: '√ötil para settings, compilaci√≥n y ajustes t√©cnicos.',
            examples: {
              python: 'show "‚öôÔ∏è config python activa"',
              html: 'show "üõ†Ô∏è build html en curso"',
              sql: 'show "üîß tuning de consulta"',
              rust: 'show "üî® compilaci√≥n rust"',
              wasm: 'show "üß± bundle wasm"',
            },
          };
        }

        if (has(/chart|abacus|numbers|math|bar chart|upwards|downwards/)) {
          return {
            type: 'Datos y c√°lculo',
            brief: 'Se usa para m√©tricas, operaciones o resultados num√©ricos.',
            examples: {
              python: 'valor = 2 + 3\nshow "üìä resultado" + valor',
              html: 'show "üìà tendencia visible"',
              sql: 'show "üßÆ agregaci√≥n aplicada"',
              rust: 'show "üìâ revisar rendimiento"',
              wasm: 'show "üìä m√©trica exportada"',
            },
          };
        }

        if (has(/lock|key|shield|security|privacy/)) {
          return {
            type: 'Seguridad y control',
            brief: 'Comunica validaciones, permisos y protecci√≥n.',
            examples: {
              python: 'verify token != null\nshow "üîí acceso validado"',
              html: 'show "üõ°Ô∏è vista protegida"',
              sql: 'show "üîê credenciales requeridas"',
              rust: 'show "üîí memoria controlada"',
              wasm: 'show "üõ°Ô∏è sandbox activo"',
            },
          };
        }

        if (has(/speech|megaphone|bell|loudspeaker|mailbox|satellite|antenna/)) {
          return {
            type: 'Comunicaci√≥n y eventos',
            brief: 'Describe mensajes, notificaciones y se√±ales del sistema.',
            examples: {
              python: 'show "üí¨ evento recibido"',
              html: 'show "üì£ notificaci√≥n visual"',
              sql: 'show "üì¨ resultado entregado"',
              rust: 'show "üîî evento emitido"',
              wasm: 'show "üì° se√±al wasm"',
            },
          };
        }

        return {
          type: 'Salida y contexto de interfaz',
          brief: 'Aporta contexto visual al mensaje mostrado en el programa.',
          examples: {
            python: 'show "‚ú® salida clara para usuario"',
            html: 'show "üåê contenido para frontend"',
            sql: 'show "üìù instrucci√≥n preparada"',
            rust: 'show "ü¶Ä m√≥dulo activo"',
            wasm: 'show "üöÄ m√≥dulo wasm listo"',
          },
        };
      }

      function enrichEmojiItem(item) {
        const fn = inferEmojiFunction(item);
        const layerExample = fn.examples[activeLayer] || fn.examples.python;
        return {
          ...item,
          functionType: fn.type,
          functionBrief: fn.brief,
          layerExample,
          tooltipText: `Funci√≥n: ${fn.type} ¬∑ Capa activa: ${activeLayer} ¬∑ Ejemplo HAND: ${layerExample}`,
        };
      }

      function _emojiText(item) {
        return `${item.emoji || ''} ${item.name || ''} ${item.tags || ''} ${item.group || ''} ${item.subgroup || ''} ${item.help || ''} ${item.functionType || ''} ${item.functionBrief || ''}`.toLowerCase();
      }

      function _emojiFilter(item) {
        const matchesQuery = !emojiState.query || _emojiText(item).includes(emojiState.query);
        const matchesCategory = !emojiState.category || item.group === emojiState.category;
        return matchesQuery && matchesCategory;
      }

      function renderEmojiCategories() {
        const categorySelect = document.getElementById('emoji-category');
        if (!categorySelect) {
          return;
        }
        categorySelect.innerHTML = '<option value="">Todas las categor√≠as</option>';
        emojiGroups.forEach((group) => {
          const option = document.createElement('option');
          option.value = group;
          option.textContent = group;
          categorySelect.appendChild(option);
        });
        categorySelect.value = emojiState.category;
      }

      function renderEmojiPalette() {
        const palette = document.getElementById('emoji-palette');
        const count = document.getElementById('emoji-count');
        const pageInfo = document.getElementById('emoji-page-info');
        const prevBtn = document.getElementById('emoji-prev-page');
        const nextBtn = document.getElementById('emoji-next-page');

        if (!palette) {
          return;
        }

        const semanticCatalog = emojiCatalog.map(enrichEmojiItem);
        const filtered = semanticCatalog.filter(_emojiFilter);
        const totalPages = Math.max(1, Math.ceil(filtered.length / emojiState.pageSize));
        emojiState.page = Math.min(Math.max(1, emojiState.page), totalPages);
        const start = (emojiState.page - 1) * emojiState.pageSize;
        const pageItems = filtered.slice(start, start + emojiState.pageSize);

        palette.querySelectorAll('[data-bs-toggle="tooltip"]').forEach((el) => {
          const tip = bootstrap.Tooltip.getInstance(el);
          if (tip) {
            tip.dispose();
          }
        });

        palette.innerHTML = '';
        pageItems.forEach((item) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn btn-light btn-sm js-insert-emoji';
          btn.dataset.emoji = item.emoji || '';
          btn.dataset.functionType = item.functionType || '';
          btn.dataset.functionBrief = item.functionBrief || '';
          btn.dataset.layerExample = item.layerExample || '';
          btn.dataset.imageDesc = item.name || '';
          btn.dataset.group = item.group || '';
          btn.setAttribute('data-bs-toggle', 'tooltip');
          btn.setAttribute('data-bs-placement', 'top');
          btn.setAttribute('title', item.tooltipText || 'Funci√≥n HAND no disponible');
          btn.textContent = item.emoji || '‚ùì';
          palette.appendChild(btn);
        });

        palette.querySelectorAll('[data-bs-toggle="tooltip"]').forEach((el) => {
          new bootstrap.Tooltip(el, { container: 'body', trigger: 'hover focus' });
        });

        if (count) {
          count.textContent = `Mostrando ${pageItems.length} de ${filtered.length} resultados (${emojiCatalog.length} emojis Unicode est√°ndar).`;
        }
        if (pageInfo) {
          pageInfo.textContent = `P√°gina ${emojiState.page} de ${totalPages}`;
        }
        if (prevBtn) {
          prevBtn.disabled = emojiState.page <= 1;
        }
        if (nextBtn) {
          nextBtn.disabled = emojiState.page >= totalPages;
        }
      }

      async function loadEmojiDataset() {
        const count = document.getElementById('emoji-count');
        try {
          if (count) {
            count.textContent = 'Cargando cat√°logo Unicode‚Ä¶';
          }
          const response = await fetch("{{ url_for('static', filename='data/emoji_dataset.json') }}", { cache: 'no-store' });
          if (!response.ok) {
            throw new Error(`No se pudo cargar dataset (HTTP ${response.status})`);
          }
          const payload = await response.json();
          emojiCatalog = Array.isArray(payload.items) ? payload.items : [];
          emojiGroups = Array.isArray(payload.groups)
            ? payload.groups
            : Array.from(new Set(emojiCatalog.map((item) => item.group).filter(Boolean))).sort();
          renderEmojiCategories();
          renderEmojiPalette();
          renderEmojiGuide();
        } catch (err) {
          emojiCatalog = [];
          emojiGroups = [];
          renderEmojiCategories();
          renderEmojiPalette();
          if (count) {
            count.textContent = `Error cargando dataset Unicode: ${err.message}`;
          }
        }
      }

      function renderEmojiGuide() {
        const layerBadge = document.getElementById('emoji-guide-layer');
        const guideMain = document.getElementById('emoji-guide-main');
        const guideSelected = document.getElementById('emoji-guide-selected');
        const guideRelated = document.getElementById('emoji-guide-related');
        const guideMap = document.getElementById('emoji-guide-map');

        if (layerBadge) {
          layerBadge.textContent = `Capa activa: ${activeLayer}`;
        }

        const catalog = emojiCatalog.map(enrichEmojiItem);
        const byType = new Map();
        catalog.forEach((item) => {
          const arr = byType.get(item.functionType) || [];
          arr.push(item);
          byType.set(item.functionType, arr);
        });

        if (guideMap) {
          const mapText = Array.from(byType.entries())
            .slice(0, 8)
            .map(([type, items]) => {
              const sample = items.slice(0, 2).map((entry) => entry.emoji).join(' ');
              return `${type}: ${sample}`;
            })
            .join(' ¬∑ ');
          guideMap.textContent = `Funciones y otros emojis sugeridos: ${mapText || 'sin datos'}.`;
        }

        if (!selectedEmoji) {
          if (guideMain) {
            guideMain.textContent = 'Selecciona un emoji para ver su tipo de funci√≥n HAND y un ejemplo seg√∫n la capa activa.';
          }
          if (guideSelected) {
            guideSelected.textContent = 'Emoji seleccionado: ninguno.';
          }
          if (guideRelated) {
            guideRelated.textContent = 'Sugerencias: selecciona un emoji para ver otros de la misma funci√≥n.';
          }
          return;
        }

        const enriched = enrichEmojiItem(selectedEmoji);
        const related = (byType.get(enriched.functionType) || [])
          .filter((item) => item.emoji !== enriched.emoji)
          .slice(0, 10)
          .map((item) => `${item.emoji} (${item.name || 'sin desc'})`)
          .join(' ¬∑ ');

        if (guideMain) {
          guideMain.textContent = `Funci√≥n principal: ${enriched.functionType}. ${enriched.functionBrief} Ejemplo (${activeLayer}): ${enriched.layerExample}`;
        }
        if (guideSelected) {
          guideSelected.textContent = `Emoji seleccionado: ${enriched.emoji} ¬∑ Descripci√≥n: ${enriched.name || 'sin descripci√≥n'} ¬∑ Categor√≠a: ${enriched.group || 'N/D'}.`;
        }
        if (guideRelated) {
          guideRelated.textContent = `Otros emojis de funci√≥n similar: ${related || 'no hay relacionados en esta categor√≠a.'}`;
        }
      }

      document.addEventListener('click', function (event) {
        const btn = event.target.closest('.js-insert-emoji');
        if (!btn) {
          return;
        }
        const emoji = btn.dataset.emoji || '';
        const editor = activeEditor || document.querySelector('textarea.editor');
        insertAtCursor(editor, emoji);

        selectedEmoji = {
          emoji,
          name: btn.dataset.imageDesc || '',
          group: btn.dataset.group || '',
          functionType: btn.dataset.functionType || '',
          functionBrief: btn.dataset.functionBrief || '',
        };
        renderEmojiGuide();
      });

      const emojiSearch = document.getElementById('emoji-search');
      if (emojiSearch) {
        emojiSearch.addEventListener('input', function () {
          emojiState.query = (this.value || '').toLowerCase().trim();
          emojiState.page = 1;
          renderEmojiPalette();
          renderEmojiGuide();
        });
      }

      const emojiCategory = document.getElementById('emoji-category');
      if (emojiCategory) {
        emojiCategory.addEventListener('change', function () {
          emojiState.category = this.value || '';
          emojiState.page = 1;
          renderEmojiPalette();
          renderEmojiGuide();
        });
      }

      const emojiPrevPageBtn = document.getElementById('emoji-prev-page');
      if (emojiPrevPageBtn) {
        emojiPrevPageBtn.addEventListener('click', function () {
          emojiState.page = Math.max(1, emojiState.page - 1);
          renderEmojiPalette();
          renderEmojiGuide();
        });
      }

      const emojiNextPageBtn = document.getElementById('emoji-next-page');
      if (emojiNextPageBtn) {
        emojiNextPageBtn.addEventListener('click', function () {
          emojiState.page += 1;
          renderEmojiPalette();
          renderEmojiGuide();
        });
      }

      const layerSelects = document.querySelectorAll('select[name="target"]');
      layerSelects.forEach((select) => {
        if (select.value) {
          activeLayer = select.value;
        }
        select.addEventListener('change', function () {
          activeLayer = this.value || 'python';
          renderEmojiPalette();
          renderEmojiGuide();
        });
        select.addEventListener('focus', function () {
          activeLayer = this.value || 'python';
          renderEmojiPalette();
          renderEmojiGuide();
        });
      });

      loadEmojiDataset();

      const uploadInput = document.getElementById('upload-documents-input');
      const dropzone = document.getElementById('upload-dropzone');
      const dropzoneStatus = document.getElementById('upload-dropzone-status');

      function updateDropzoneStatus(files) {
        if (!dropzoneStatus) {
          return;
        }
        const selected = files || (uploadInput ? uploadInput.files : null);
        if (!selected || !selected.length) {
          dropzoneStatus.textContent = 'Sin archivos seleccionados.';
          return;
        }
        const names = Array.from(selected).slice(0, 4).map((f) => f.name);
        const suffix = selected.length > 4 ? ` +${selected.length - 4} m√°s` : '';
        dropzoneStatus.textContent = `${selected.length} archivo(s): ${names.join(', ')}${suffix}`;
      }

      if (dropzone && uploadInput) {
        ['dragenter', 'dragover'].forEach((evt) => {
          dropzone.addEventListener(evt, function (e) {
            e.preventDefault();
            e.stopPropagation();
            dropzone.classList.add('dropzone-upload-active');
          });
        });

        ['dragleave', 'dragend', 'drop'].forEach((evt) => {
          dropzone.addEventListener(evt, function (e) {
            e.preventDefault();
            e.stopPropagation();
            dropzone.classList.remove('dropzone-upload-active');
          });
        });

        dropzone.addEventListener('drop', function (e) {
          const files = e.dataTransfer && e.dataTransfer.files ? e.dataTransfer.files : null;
          if (!files || !files.length) {
            return;
          }
          const dt = new DataTransfer();
          Array.from(files).forEach((file) => dt.items.add(file));
          uploadInput.files = dt.files;
          updateDropzoneStatus(dt.files);
        });

        dropzone.addEventListener('click', function () {
          uploadInput.click();
        });

        dropzone.addEventListener('keydown', function (e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            uploadInput.click();
          }
        });

        uploadInput.addEventListener('change', function () {
          updateDropzoneStatus(this.files);
        });

        updateDropzoneStatus(uploadInput.files);
      }

      const commonSelect = document.getElementById('common_action_key');
      const commonRunBtn = document.getElementById('run-common-command-btn');
      if (commonSelect && commonRunBtn) {
        commonRunBtn.addEventListener('click', function () {
          const selected = commonSelect.options[commonSelect.selectedIndex];
          if (!selected) {
            return;
          }
          const title = selected.dataset.label || selected.textContent || 'Comando com√∫n';
          const help = selected.dataset.help || 'Ejecuta el comando seleccionado.';
          const command = selected.dataset.command || '';
          openHelp(`Comando com√∫n ¬∑ ${title}`, help, command, 'common-command-form');
        });
      }

      const onboardingSeenKey = 'hand_control_center_onboarding_seen_v1';
      if (!localStorage.getItem(onboardingSeenKey)) {
        onboardingModal.show();
      }
      if (onboardingBtn) {
        onboardingBtn.addEventListener('click', function () {
          localStorage.setItem(onboardingSeenKey, '1');
          onboardingModal.hide();
        });
      }
      onboardingEl.addEventListener('hidden.bs.modal', function () {
        localStorage.setItem(onboardingSeenKey, '1');
      });
    })();
  </script>
</body>
</html>
